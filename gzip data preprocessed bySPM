!pip install numpy==1.22.4
!pip install nibabel
!pip install FuzzyTM


import os
import glob
import nibabel as nib
import numpy as np
import gzip
import shutil


###
root_path = 'C:/Users/User/Desktop/JSR/spm_prep_bids'

for i in range(1, 39):
    sbj_id = f'sub_{i}'
    files_in = sorted(glob.glob(os.path.join(root_path, 'spmprep_v5', sbj_id, 'func', 'raf*.nii')))

    # .nii to 4D numpy array
    data_list = [nib.load(file).get_fdata() for file in files_in]

    # merge to 4D .nii file
    merged_data = np.stack(data_list, axis=-1)
    merged_img = nib.Nifti1Image(merged_data, np.eye(4))

    # save .nii
    output_filename = os.path.join(root_path, f'{sbj_id}_preproc_bold.nii')
    #nib.save(merged_img, output_filename)
   
   
###
# .nii to .nii.gz
for i in range(1, 39):
    sbj_id = f'sub_{i}'
    output_filename = os.path.join(root_path, 'derivatives', sbj_id, 'func', f'{sbj_id}_preproc_bold.nii')
    if os.path.isfile(output_filename): 
        with open(output_filename, 'rb') as f_in:
            with gzip.open(f'{output_filename}.gz', 'wb') as f_out:
                shutil.copyfileobj(f_in, f_out)
        #remove .nii
        os.remove(output_filename)
